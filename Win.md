# Win

这个md用于记录学习中遇到的内核相关知识

## API







## 异常处理

### 异常分发函数 ntdll.KiUserExceptionDispatcher

所有异常都会经过这个函数









## Intel CPU的特权级别

级别由高到低分为RING0、RING1、RING2、RING3。

windows使用RING0和RING3两个级别，**RING0**给操作系统用，而**RING3**谁都能用。

RING0可以 使用特权指令，控制中断、修改页表、访问设备等等

这些RING3不行，否则会发生错误。如果用户希望使用RING0的功能，那就需要执行系统调用。

执行**系统调用**的时候，CPU 的运行级别会发生从 ring3 到 ring0 的**切换**，并跳转到系统调用对应的内核代码位置执行，这样内核就为你完成了设备访问，完成之后再从 ring0 **返回** ring3。这个过程也称作**用户态**和**内核态**的切换。 

利：RING设计的初衷是将系统权限与程序分离出来，使之能够让 OS 更好的管理当前系统资源，也使得系统更加稳定。

弊：RING0 不允许出现多个 OS 同时运行在上面，最早的解决办法便是使用虚拟机，把 OS 当成一个程序来运行。







### 调用约定

在 64 位 Windows 程序中，函数的前 4 个整数/指针参数**不是**压入堆栈的，而是依次存放在寄存器中：

- 第 1 个参数 -> **RCX**
- 第 2 个参数 -> **RDX**
- 第 3 个参数 -> **R8**
- 第 4 个参数 -> **R9**

例：

对于ws2_32.dll中的connect函数

```c
int connect(

 SOCKET     s,    // 第1个参数 (RCX): Socket句柄 (我们不关心)

 const sockaddr *name,  // 第2个参数 (RDX): 指向地址结构体的指针 (关键！)

 int       namelen  // 第3个参数 (R8):  结构体长度

);
```

第二个参数是指向地址结构体的指针，其中包含了ip和port，而它被存放在rdx寄存器中

![image-20251217112458380](Win.assets/image-20251217112458380.png)

在内存窗口转到该地址，可以看到如图所示数据，前两个字节表示IPv4协议，后面两个字节是端口号，再后面四个字节是ip地址
